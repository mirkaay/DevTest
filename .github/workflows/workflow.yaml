name: 'Terraform CI'

on:
  push:
    branches:
    - main
  
env:
     PROJECT_ID: ${{ secrets.PUBSUB_PROJECT }}
     GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
     PR_AUTHOR: ${{ github.event.pull_request.user.login }}
  
jobs:       
 setup-build-publish-deploy:    
     name: Setup, Build, Publish, and Deploy
     runs-on: ubuntu-latest 
    
     defaults:
      run:
        shell: bash
      
     steps:
     - name: Checkout
       uses: actions/checkout@v2
     - name: Set up gcloud Cloud SDK environment
       uses: google-github-actions/setup-gcloud@v0.2.0
       with:
          service_account_key: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
          project_id: ${{ secrets.PUBSUB_PROJECT }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          export_default_credentials: true
          
     - run: |-
             echo "$PR_AUTHOR is requesting access to main"
             gcloud pubsub topics publish notifications. --message createdbymisbah
             gcloud pubsub subscriptions pull --auto-ack echo
             
             shell: bash
